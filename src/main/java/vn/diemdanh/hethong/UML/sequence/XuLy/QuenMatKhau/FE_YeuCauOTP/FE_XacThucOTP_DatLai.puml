@startuml
!theme plain
title 3. Xác thức OTP và Đặt lại mật khẩu - Frontend

actor User as U
participant "XacThucOtpFORMComponents.jsx" as VOF
participant "matKhauService.js" as MS
participant "api.js" as API

== Bước 2: Xác thực OTP và đặt lại mật khẩu ==

U -> VOF: Truy cập /:userType/verify-otp
VOF -> VOF: Kiểm tra sessionStorage.getItem('resetEmail')

alt Không có resetEmail
    VOF -> U: Chuyển hướng về trang quên mật khẩu
else Có resetEmail
    VOF -> VOF: Hiển thị email từ sessionStorage

    U -> VOF: Nhập OTP, mật khẩu mới, xác nhận mật khẩu
    U -> VOF: Nhấn "Xác nhận"

    VOF -> VOF: handleSubmit() - Kiểm tra:
    note right of VOF
    - Mật khẩu và xác nhận mật khẩu phải khớp
    - Mật khẩu tối thiểu 6 ký tự
    end note

    alt Validation thành công
        VOF -> MS: verifyOTPAndResetPassword({email, otp, newPassword}, userType)
        MS -> API: POST request tới endpoint:
        note right of API
        - STUDENT/TEACHER: /api/password-reset/user/verify-otp
        - ADMIN: /api/password-reset/admin/verify-otp
        Payload: { email, otp, newPassword }
        end note

        alt Xác thực thành công
            API -> MS: Success response
            MS -> VOF: Success
            VOF -> VOF: Xóa resetEmail khỏi sessionStorage
            VOF -> VOF: Hiển thị "Đặt lại mật khẩu thành công!" (1 giây)
            VOF -> U: Sau 2 giây chuyển hướng tới /:userType/login?reset=success
        else Xác thực thất bại
            API -> MS: Error (OTP sai, hết hạn, v.v.)
            MS -> VOF: Error response
            VOF -> U: Hiển thị thông báo lỗi
        end
    else Validation thất bại
        VOF -> U: Hiển thị lỗi validation
    end
end

== Gửi lại OTP ==

VOF -> VOF: Bộ đếm 60 giây (countdown)
alt Sau 60 giây
    U -> VOF: Nhấn "Gửi lại mã OTP"
    VOF -> MS: requestOTP(email, userType)
    VOF -> VOF: Reset countdown và vô hiệu hóa nút gửi lại
end

@enduml