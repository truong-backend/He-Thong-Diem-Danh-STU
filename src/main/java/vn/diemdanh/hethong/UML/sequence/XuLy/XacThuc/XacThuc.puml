@startuml
!theme plain
title Luồng bảo mật và xác thực

participant "Client Request" as client
participant "JwtAuthenticationFilter.java" as jwtFilter
participant "JwtTokenProvider.java" as jwtProvider
participant "WebSecurityConfig.java" as securityConfig
participant "CustomDetails" as Details
participant "Controller.java" as controller

  note right of Details
                CustomDetails có thể là:
                - CustomUserDetails.java
                - CustomAdminDetails.java
  end note

client -> jwtFilter: Request với JWT token
activate jwtFilter
jwtFilter -> jwtFilter: Lấy token từ Authorization header
jwtFilter -> jwtProvider: validateToken(token)
activate jwtProvider

alt Token không hợp lệ hoặc hết hạn
    jwtProvider --> jwtFilter: false
    jwtFilter --> client: HTTP 401 Unauthorized
else Token hợp lệ
    jwtProvider --> jwtFilter: true
    jwtFilter -> jwtProvider: getAdminIdFromToken(token)
    jwtProvider --> jwtFilter: adminId

    jwtFilter -> Details: loadUserByUsername(adminId)
    activate Details
    Details -> Details: Tạo UserDetails với ROLE
                note right
                ROLE co thể là:
                - ROLE_ADMIN: Lấy role theo Admin
                - ROLE_TEACHER: Lấy role theo Giảng Viên
                - ROLE_STUDENT: Lấy role theo Sinh Viên
                end note
    Details --> jwtFilter: UserDetails
    deactivate Details

    jwtFilter -> securityConfig: Kiểm tra quyền truy cập
    activate securityConfig
    securityConfig -> securityConfig: Yêu cầu ROLE cho để truy cập endpoint


    alt Không có quyền ROLE_ADMIN
        securityConfig --> client: HTTP 403 Forbidden
    else Có quyền ROLE_ADMIN
        securityConfig --> jwtFilter: Cho phép truy cập
        deactivate securityConfig
        jwtFilter -> controller: Chuyển tiếp request
        activate controller
        controller -> controller: Xử lý business logic
        controller --> client: Response
        deactivate controller
    end
end

deactivate jwtProvider
deactivate jwtFilter
@enduml