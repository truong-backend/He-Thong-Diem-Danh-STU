@startuml
!theme plain
title 5. Form Đặt lại mật khẩu dự phòng (Token)

actor User as U
participant "DatLaiMatKhauFORMComponents.jsx" as RPF
participant "matKhauService.js" as MS
participant "api.js" as API
participant "Backend Controller" as BC

== Bước 3: Đặt lại mật khẩu với token (dự phòng) ==

note over U, BC
**Lưu ý:** Chỉ sử dụng nếu backend trả về resetToken
trong bước xác thực OTP thay vì cập nhật trực tiếp
end note

alt Backend trả về resetToken từ verify-otp
    U -> RPF: Được chuyển hướng với resetToken
    RPF -> RPF: Lấy token từ sessionStorage/URL params

    U -> RPF: Nhập mật khẩu mới và xác nhận mật khẩu
    note right: Mật khẩu tối thiểu 8 ký tự

    U -> RPF: Nhấn "Đặt lại mật khẩu"
    RPF -> RPF: Validate mật khẩu khớp và >= 8 ký tự

    alt Validation thành công
        RPF -> MS: resetPassword(token, newPassword, userType)
        MS -> API: POST request tới:
        note right of API
        - STUDENT/TEACHER: /api/password-reset/user/reset-password
        - ADMIN: /api/password-reset/admin/reset-password
        Payload: { token, newPassword }
        end note

        API -> BC: Kiểm tra resetToken hợp lệ và liên kết với email

        alt Token hợp lệ
            BC -> BC: Cập nhật mật khẩu (tương tự bước verify OTP)
            BC -> BC: Xóa token sau khi sử dụng
            BC -> API: 200 "Mật khẩu đã được cập nhật"
            API -> MS: Success
            MS -> RPF: Success
            RPF -> RPF: Xóa resetToken và resetEmail khỏi sessionStorage
            RPF -> U: Chuyển hướng tới /:userType/login?reset=success
        else Token không hợp lệ
            BC -> API: 400 "Token không hợp lệ hoặc hết hạn"
            API -> MS: Error
            MS -> RPF: Error
            RPF -> U: Hiển thị thông báo lỗi
        end
    else Validation thất bại
        RPF -> U: Hiển thị lỗi validation
    end
else Luồng chính (không có token)
    note over RPF
    XacThucOtpFORMComponents.jsx đã xử lý
    việc đặt lại mật khẩu trực tiếp,
    nên form này có thể không được sử dụng
    end note
end

@enduml