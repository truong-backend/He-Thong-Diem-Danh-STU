@startuml
!theme plain
title 2. Đăng nhập Sinh viên (Student Login)

participant "api.js" as API
participant "AuthController" as AUTH
participant "UserService" as US
participant "JwtTokenProvider" as JWT
database "UserRepository" as UR

== Xử lý đăng nhập cho Sinh viên ==

API -> AUTH: POST /api/sinhvien/login\n{email, password}
activate AUTH

AUTH -> AUTH: Kiểm tra email có đuôi @student.stu.edu.vn

alt Email không hợp lệ
    AUTH -> API: 400 "Email không hợp lệ"
    note right: Trả về lỗi cho Frontend
    deactivate AUTH
else Email hợp lệ
    AUTH -> AUTH: Tạo UsernamePasswordAuthenticationToken

    AUTH -> US: Xác thực qua AuthenticationManager
    activate US

    US -> UR: loadUserByUsername(email)
    activate UR

    alt Không tìm thấy user hoặc sai password
        UR --> US: User not found/Invalid password
        deactivate UR

        US --> AUTH: BadCredentialsException
        deactivate US

        AUTH -> API: 400 "Email hoặc mật khẩu không chính xác"
        deactivate AUTH
    else Xác thực thành công
        UR --> US: CustomUserDetails (ROLE_STUDENT)
        deactivate UR

        US --> AUTH: Authentication success
        deactivate US

        AUTH -> JWT: generateToken(userDetails)
        activate JWT
        note right: JWT chứa:\n- userId, email, role\n- username, userType="USER"
        JWT --> AUTH: JWT token
        deactivate JWT

        AUTH -> API: UserLoginResponse:\n{accessToken, id, username, email, role="STUDENT"}
        deactivate AUTH
    end
end

@enduml
