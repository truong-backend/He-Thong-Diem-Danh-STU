@startuml
!theme plain
title 4. Xử lý Lỗi Đặc biệt

participant "AuthController" as AUTH
participant "UserService" as US
participant "AdminService" as AS
participant "api.js" as API

== Các trường hợp lỗi đặc biệt ==

note over AUTH, AS
**Các loại lỗi có thể xảy ra:**

1. **ClassCastException**
   - Tài khoản không đúng loại
   - Response: "Tài khoản không hợp lệ cho đăng nhập"

2. **AccountStatusException**
   - Tài khoản bị khóa/vô hiệu hóa
   - Response: "Tài khoản đã bị khóa"

3. **DataAccessException**
   - Lỗi kết nối database
   - Response: "Lỗi hệ thống, vui lòng thử lại"

4. **JwtException**
   - Lỗi tạo JWT token
   - Response: "Lỗi xác thực, vui lòng thử lại"

5. **BadCredentialsException**
   - Email hoặc password sai
   - Response: "Email hoặc mật khẩu không chính xác"
end note

activate AUTH
AUTH -> US: Gọi xác thực người dùng
activate US
US -> US: Quá trình xác thực (gồm truy vấn DB và kiểm tra trạng thái)
deactivate US

AUTH -> AS: (Nếu là Admin) Gọi xác thực qua AdminService
activate AS
AS -> AS: Quá trình xác thực và quyền
deactivate AS

alt Xảy ra lỗi đặc biệt
    AUTH -> API: Trả về lỗi với status code tương ứng
    note right
    - 400: Bad Request (validation, credentials)
    - 401: Unauthorized (authentication failed)
    - 403: Forbidden (access denied)
    - 500: Internal Server Error (system error)
    end note
end
deactivate AUTH

@enduml
