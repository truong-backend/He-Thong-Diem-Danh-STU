@startuml
!theme plain
title Luồng xuất danh sách lớp học ra Excel

participant "Header Component" as header
participant "DanhSachLopComponents.jsx" as component
participant "XLSX Library" as xlsx
participant "file-saver" as fileSaver
participant "Browser" as browser

== Bắt đầu xuất Excel ==
header -> component: Người dùng nhấn "Xuất Excel" (DownloadOutlined)
component -> component: exportToExcel()

== Chuẩn bị dữ liệu ==
component -> component: Lấy dữ liệu từ allLops (đã có từ fetchData)
component -> component: applyFilters(allLops, { selectedKhoa, searchText })
note right: Áp dụng bộ lọc hiện tại
component -> component: applySorting(filteredData)
note right: Sắp xếp theo tiêu chí hiện tại

== Tạo file Excel ==
component -> component: Tạo data array với các cột:
note over component
[
  ["STT", "Mã Lớp", "Tên Lớp", "Khoa", "GVCN", "SĐT GVCN"],
  [1, "LOP001", "Công nghệ thông tin 1", "CNTT", "Nguyễn Văn A", "0123456789"],
  ...
]
end note

component -> xlsx: XLSX.utils.aoa_to_sheet(data)
xlsx --> component: worksheet object

component -> component: Thiết lập độ rộng cột (wscols)
note right
- STT: 50px
- Mã lớp: 100px
- Tên lớp: 200px
- Khoa: 120px
- GVCN: 150px
- SĐT: 120px
end note

component -> xlsx: XLSX.utils.book_new()
xlsx --> component: workbook object

component -> xlsx: XLSX.utils.book_append_sheet(workbook, worksheet, "Danh sách lớp học")

== Tạo tên file ==
component -> component: Tạo tên file với format:
note right
"DanhSachLopHoc_[NgayThangNam]_[FilterInfo].xlsx"
Ví dụ: "DanhSachLopHoc_20240315_Khoa-CNTT_TimKiem-ABC.xlsx"
end note

== Tải file ==
component -> xlsx: XLSX.writeFile() hoặc XLSX.write()
xlsx --> component: File buffer/blob

alt Sử dụng file-saver
    component -> fileSaver: saveAs(blob, filename)
    fileSaver -> browser: Trigger download
    browser -> browser: Tải file về máy người dùng

    == Xử lý thành công ==
    component -> component: message.success("Xuất Excel thành công")

else Lỗi trong quá trình tạo file
    component -> component: message.error("Lỗi khi xuất Excel")
end

note over component
Xuất Excel được thực hiện hoàn toàn
phía client, sử dụng dữ liệu đã có
trong allLops, không cần gọi API mới
end note

== Thông tin file Excel ==
note over xlsx
File Excel chứa:
- Header: STT, Mã Lớp, Tên Lớp, Khoa, GVCN, SĐT GVCN
- Dữ liệu: Danh sách lớp học đã lọc và sắp xếp
- Format: .xlsx
- Encoding: UTF-8
- Tên sheet: "Danh sách lớp học"
end note

@enduml