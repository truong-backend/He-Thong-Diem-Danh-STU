@startuml
!theme plain
title Luồng bảo mật và xác thực

participant "Client Request" as client
participant "JwtAuthenticationFilter.java" as jwtFilter
participant "JwtTokenProvider.java" as jwtProvider
participant "WebSecurityConfig.java" as securityConfig
participant "CustomAdminDetails.java" as adminDetails
participant "AdminController.java" as controller

client -> jwtFilter: Request với JWT token
activate jwtFilter
jwtFilter -> jwtFilter: Lấy token từ Authorization header
jwtFilter -> jwtProvider: validateToken(token)
activate jwtProvider

alt Token không hợp lệ hoặc hết hạn
    jwtProvider --> jwtFilter: false
    jwtFilter --> client: HTTP 401 Unauthorized
else Token hợp lệ
    jwtProvider --> jwtFilter: true
    jwtFilter -> jwtProvider: getAdminIdFromToken(token)
    jwtProvider --> jwtFilter: adminId

    jwtFilter -> adminDetails: loadUserByUsername(adminId)
    activate adminDetails
    adminDetails -> adminDetails: Tạo UserDetails với ROLE_ADMIN
    adminDetails --> jwtFilter: UserDetails
    deactivate adminDetails

    jwtFilter -> securityConfig: Kiểm tra quyền truy cập
    activate securityConfig
    securityConfig -> securityConfig: Yêu cầu ROLE_ADMIN cho /api/admin/**

    alt Không có quyền ROLE_ADMIN
        securityConfig --> client: HTTP 403 Forbidden
    else Có quyền ROLE_ADMIN
        securityConfig --> jwtFilter: Cho phép truy cập
        deactivate securityConfig
        jwtFilter -> controller: Chuyển tiếp request
        activate controller
        controller -> controller: Xử lý business logic
        controller --> client: Response
        deactivate controller
    end
end

deactivate jwtProvider
deactivate jwtFilter
@enduml