@startuml
!theme plain
title Luồng Xác Thực và Phân Quyền với JWT

participant "Client" as client
participant "JwtAuthenticationFilter" as jwtFilter
participant "JwtTokenProvider" as jwtProvider
participant "CustomUserDetailsService" as details
participant "WebSecurityConfig" as security
participant "Controller" as controller

== Gửi yêu cầu với JWT ==
client -> jwtFilter: Gửi request (có Authorization header)
jwtFilter -> jwtProvider: validateToken(token)
activate jwtProvider

alt Token không hợp lệ/hết hạn
    jwtProvider --> jwtFilter: false
    jwtFilter --> client: 401 Unauthorized
else Token hợp lệ
    jwtProvider --> jwtFilter: true
    jwtFilter -> jwtProvider: getUserIdFromToken(token)
    jwtProvider --> jwtFilter: userId

    == Xác định người dùng và quyền ==
    jwtFilter -> details: loadUserByUsername(userId)
    activate details
    details --> jwtFilter: UserDetails (ROLE_XXX)
    deactivate details

    == Kiểm tra quyền truy cập ==
    jwtFilter -> security: check role for endpoint
    activate security

    alt Không đủ quyền
        security --> client: 403 Forbidden
    else Đủ quyền
        security --> jwtFilter: Access granted
        deactivate security

        == Gọi Controller ==
        jwtFilter -> controller: Forward request
        activate controller
        controller -> controller: Xử lý nghiệp vụ
        controller --> client: Trả kết quả
        deactivate controller
    end
end

deactivate jwtProvider
@enduml
