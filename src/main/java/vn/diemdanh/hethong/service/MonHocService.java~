package vn.diemdanh.hethong.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import vn.diemdanh.hethong.dto.diemdanh.MonHocSinhVienDto;
import vn.diemdanh.hethong.dto.lichhoc.LichHocTheoThuDto;
import vn.diemdanh.hethong.dto.monhoc.MonHocDto;
import vn.diemdanh.hethong.dto.monhoc.MonHocGiangVienDTO;
import vn.diemdanh.hethong.dto.monhoc.NhomMonHocDTO;
import vn.diemdanh.hethong.dto.tkb.ThoiKhoaBieuDTO;
import vn.diemdanh.hethong.repository.MonHocRepository;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class MonHocService {
    @Autowired
    private MonHocRepository monHocRepository;




    // 2. LẤY DANH SÁCH MÔN HỌC CỦA GIẢNG VIÊN
    public List<MonHocGiangVienDTO> getSubjectsByTeacher(String maGv, Integer hocKy, Integer namHoc) {
//        log.info("Fetching subjects for teacher: {}, semester: {}, year: {}", maGv, hocKy, namHoc);
        List<Object[]> results = monHocRepository.findSubjectsByTeacher(maGv, hocKy, namHoc);

        return results.stream()
                .map(row -> MonHocGiangVienDTO.builder()
                        .maMh((String) row[0])
                        .tenMh((String) row[1])
                        .hocKy((Integer) row[2])
                        .namHoc(((Number) row[3]).intValue())
                        .build())
                .collect(Collectors.toList());
    }
    // 3. LẤY DANH SÁCH NHÓM MÔN HỌC
    public List<NhomMonHocDTO> getSubjectGroups(String maGv, String maMh, Integer hocKy, Integer namHoc) {
//        log.info("Fetching subject groups for teacher: {}, subject: {}", maGv, maMh);
        List<Object[]> results = monHocRepository.findSubjectGroups(maGv, maMh, hocKy, namHoc);

        return results.stream()
                .map(row -> NhomMonHocDTO.builder()
                        .maGd((Integer) row[0])
                        .nhomMonHoc((Integer) row[1])
                        .tenMh((String) row[2])
                        .phongHoc((String) row[3])
                        .ngayBd(((java.sql.Date) row[4]).toLocalDate())
                        .ngayKt(((java.sql.Date) row[5]).toLocalDate())
                        .caHoc((String) row[6])
                        .build())
                .collect(Collectors.toList());
    }
    // 4. LẤY DANH SÁCH MÔN HỌC CỦA SINH VIÊN
    public List<MonHocSinhVienDto> getMonHocCuaSinhVien(String maSv) {
        List<Object[]> results = monHocRepository.findMonHocByMaSv(maSv);

        return results.stream()
                .map(r -> MonHocSinhVienDto.builder()
                        .maMh((String) r[0])
                        .tenMh((String) r[1])
                        .soTiet(((Number) r[2]).intValue()) // an toàn nếu là Integer/BigInteger
                        .nmh((Integer) r[3])
                        .hocKy((Integer) r[4])
                        .phongHoc((String) r[5])
                        .ngayBd(((java.sql.Date) r[6])) // nếu dùng LocalDate
                        .ngayKt(((java.sql.Date) r[7]))
                        .build())
                .collect(Collectors.toList());
    }
    //lấy danh sách
    public List<LichHocTheoThuDto> getLichHocTheoThu(int thu) {
        List<Object[]> results = monHocRepository.findLichHocByThu(thu);

        return results.stream()
                .map(row -> LichHocTheoThuDto.builder()
                        .tenMonHoc((String) row[0])
                        .tenGiaoVien((String) row[1])
                        .ngayHoc((Date) row[2])
                        .tietBatDau(((Number) row[3]).intValue())
                        .tietKetThuc(((Number) row[4]).intValue())
                        .build())
                .collect(Collectors.toList());
    }
    //lấy danh sách môn của sinh viên để phục vụ hiển thị thời khóa biếu
    public List<ThoiKhoaBieuDTO> getThoiKhoaBieuByMaSv(String maSv) {
        List<Object[]> rawList = monHocRepository.findThoiKhoaBieuByMaSv(maSv);

        return rawList.stream().map(obj -> ThoiKhoaBieuDTO.builder()
                .maMonHoc((String) obj[0])
                .tenMonHoc((String) obj[1])
                .nhomMonHoc(((Number) obj[2]).intValue())  // cast Long -> Integer
                .soTiet(((Number) obj[3]).intValue())
                .maLop((String) obj[4])
                .thu(((Number) obj[5]).intValue())
                .tietBD(((Number) obj[6]).intValue())
                .phong((String) obj[7])
                .tenGiaoVien((String) obj[8])
                .tuanNgayBatDauKetThuc((String) obj[9])
                .build()
        ).collect(Collectors.toList());
    }
    //    //lay danh sach mon hoc cho trong quan tri vien
    public List<MonHocDto> getMonHocByHocKyAndNam(Integer hocKy, Integer namHoc) {
        List<Object[]> results = monHocRepository.findMonHocByHocKyAndNam(hocKy, namHoc);
        return results.stream()
                .map(row -> new MonHocDto(
                        (String) row[0],
                        (String) row[1],
                        (Number) row[2],

                ))
                .collect(Collectors.toList());
    }
}
