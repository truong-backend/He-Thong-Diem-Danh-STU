package vn.diemdanh.hethong.service.forgot_password;


import jakarta.transaction.Transactional;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import vn.diemdanh.hethong.entity.PasswordReset;
import vn.diemdanh.hethong.entity.User;
import vn.diemdanh.hethong.exception.OtpExpiredException;
import vn.diemdanh.hethong.exception.OtpInvalidException;
import vn.diemdanh.hethong.exception.UserNotFoundException;
import vn.diemdanh.hethong.repository.login.PasswordResetRepository;
import vn.diemdanh.hethong.repository.login.UserRepository;
import vn.diemdanh.hethong.service.email.EmailService;

import java.time.Duration;
import java.time.Instant;
import java.util.Optional;
import java.util.Random;

@Service
@Slf4j
public class PasswordResetService {

    @Autowired
    private PasswordResetRepository passwordResetRepository;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private EmailService emailService;

    @Autowired
    private PasswordEncoder passwordEncoder;

    // Thời gian hiệu lực của OTP (3 phút)
    private static final long OTP_EXPIRATION_MINUTES = 3;

    /**
     * Tạo OTP ngẫu nhiên 6 số và gửi qua email
     */
    @Transactional
    public void createAndSendOtp(String email) {
        // Kiểm tra xem email có tồn tại không
        if (!userRepository.findByEmail(email).isPresent()) {
            throw new UserNotFoundException("Không tìm thấy người dùng với email: " + email);
        }

        // Tạo OTP 6 số ngẫu nhiên
        String otp = generateRandomOtp();

        // Lưu OTP vào database
        saveOtp(email, otp);

        // Gửi OTP qua email
        sendOtpEmail(email, otp);
    }

    /**
     * Xác minh OTP và đặt lại mật khẩu
     */
    @Transactional
    public void verifyOtpAndResetPassword(String email, String otp, String newPassword) {
        // Lấy thông tin OTP từ database
        Optional<PasswordReset> passwordResetOptional = passwordResetRepository.findById(email);

        if (!passwordResetOptional.isPresent()) {
            throw new OtpInvalidException("Không tìm thấy yêu cầu đặt lại mật khẩu cho email này");
        }

        PasswordReset passwordReset = passwordResetOptional.get();

        // Kiểm tra xem OTP có hợp lệ không
        if (!passwordEncoder.matches(otp, passwordReset.getToken())) {
            throw new OtpInvalidException("Mã OTP không chính xác");
        }

        // Kiểm tra xem OTP có còn hiệu lực không
        if (isOtpExpired(passwordReset.getCreatedAt())) {
            throw new OtpExpiredException("Mã OTP đã hết hạn");
        }

        // Cập nhật mật khẩu mới
        Optional<User> userOptional = userRepository.findByEmail(email);
        if (!userOptional.isPresent()) {
            throw new UserNotFoundException("Không tìm thấy người dùng với email: " + email);
        }

        User user = userOptional.get();
        user.setPassword(passwordEncoder.encode(newPassword));
        userRepository.save(user);

        // Xóa bản ghi OTP sau khi đặt lại mật khẩu thành công
        passwordResetRepository.deleteById(email);
    }

    /**
     * Tạo OTP ngẫu nhiên 6 số
     */
    private String generateRandomOtp() {
        Random random = new Random();
        int otp = 100000 + random.nextInt(900000); // Tạo số ngẫu nhiên từ 100000 đến 999999
        return String.valueOf(otp);
    }

    /**
     * Lưu OTP vào database
     */
    private void saveOtp(String email, String otp) {
        PasswordReset passwordReset = new PasswordReset();
        passwordReset.setEmail(email);
        passwordReset.setToken(passwordEncoder.encode(otp)); // Mã hóa OTP trước khi lưu
        passwordReset.setCreatedAt(Instant.now());

        passwordResetRepository.save(passwordReset);
    }

    /**
     * Gửi OTP qua email
     */
    private void sendOtpEmail(String email, String otp) {
        String subject = "Mã OTP đặt lại mật khẩu";
        String content = "Mã OTP để đặt lại mật khẩu của bạn là: " + otp + "\n"
                + "Mã này sẽ hết hạn sau " + OTP_EXPIRATION_MINUTES + " phút.";

        emailService.sendEmail(email, subject, content);
    }

    /**
     * Kiểm tra xem OTP có hết hạn không
     */
    private boolean isOtpExpired(Instant createdAt) {
        Instant now = Instant.now();
        Duration duration = Duration.between(createdAt, now);
        return duration.toMinutes() > OTP_EXPIRATION_MINUTES;
    }
}