package vn.diemdanh.hethong.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import vn.diemdanh.hethong.dto.diemdanh.MonHocDto;
import vn.diemdanh.hethong.entity.MonHoc;

import java.util.List;

public interface MonHocRepository extends JpaRepository<MonHoc, String> {
    //Lấy danh sách môn học của giảnh viên đó trong học kỳ đó
    @Query(value = """
        SELECT DISTINCT mh.ma_mh AS maMh, mh.ten_mh AS tenMh
        FROM lich_gd lg
        JOIN mon_hoc mh ON lg.ma_mh = mh.ma_mh
        WHERE lg.ma_gv = :maGv AND lg.hoc_ky = :hocKy
        """, nativeQuery = true)
    List<MonHocDto> findDistinctMonHocByGiaoVienAndHocKy(
    @Param("maGv") String maGv,
    @Param("hocKy") int hocKy
    );
    // Lấy danh sách nhóm môn học của môn hoc đó của giảng viên đó trong học kỳ đó
    @Query(value = "SELECT DISTINCT lg.nmh " +
            "FROM lich_gd lg " +
            "WHERE lg.ma_gv = :maGv " +
            "AND lg.ma_mh = :maMh " +
            "AND lg.hoc_ky = :hocKy", nativeQuery = true)
    List<Integer> findDistinctNhomMonHocByMaGvAndMaMhAndHocKy(@Param("maGv") String maGv,
                                                              @Param("maMh") String maMh,
                                                              @Param("hocKy") int hocKy);

    // 2. LẤY DANH SÁCH MÔN HỌC CỦA GIẢNG VIÊN THEO HỌC KỲ VÀ NĂM
    @Query(value = """
        SELECT DISTINCT 
            lg.ma_mh,
            mh.ten_mh,
            lg.hoc_ky,
            YEAR(lg.ngay_bd) as nam_hoc
        FROM lich_gd lg
        JOIN mon_hoc mh ON lg.ma_mh = mh.ma_mh
        WHERE lg.ma_gv = :maGv
            AND lg.hoc_ky = :hocKy
            AND YEAR(lg.ngay_bd) = :namHoc
        ORDER BY mh.ten_mh
        """, nativeQuery = true)
    List<Object[]> findSubjectsByTeacher(@Param("maGv") String maGv,
                                         @Param("hocKy") Integer hocKy,
                                         @Param("namHoc") Integer namHoc);
} 